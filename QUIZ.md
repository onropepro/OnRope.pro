# Employee Document Quiz System

## GOLDEN RULES - MANDATORY FOR ALL DEVELOPMENT

### Rule 1: Complete Testing Before Proceeding
**Every step MUST be tested and working 100% before moving to the next step. No exceptions.**

Before proceeding to the next step of the build, the following must be verified:
- Backend code reviewed and working
- Frontend code reviewed and working
- Database schema correct and all tables created and available
- Routes tested and functional
- No LSP errors
- API wording correct
- API calls returning correct data
- Every endpoint tested

This rule applies between EACH step of the build. No exception will be acceptable.

### Rule 2: Stay Within Scope
- Do NOT wander away doing things that were not asked
- Do NOT freelance or add extra features
- Do NOT assume - ask if unclear
- Do NOT touch code that does not need to be touched
- Do NOT add functions that were not asked to be added
- Do NOT alter any other function or feature of the app unless approved by the user

---

## Overview

Companies can earn additional CSR points by having employees complete quizzes based on uploaded documents. The system uses AI to read the uploaded document and automatically generate quiz questions.

---

## Supported Documents for Quiz Generation

1. **Health & Safety Manual** - When uploaded, AI generates a 20-question quiz
2. **Company Policy** - When uploaded, AI generates a 20-question quiz

---

## Quiz Specifications

### Format
- **20 questions** per quiz
- **4 multiple choice options** per question (A, B, C, D)
- Questions are generated by AI reading the actual document content
- Questions test understanding of key policies, procedures, and safety requirements

### Passing Score
- **80% required to pass** (16 out of 20 correct)
- Only passing scores count toward CSR points
- Failed attempts can be retried

---

## CSR Points

### Points Awarded
- **1 point per employee** who completes the quiz with 80% or higher score
- Points apply to the company's overall CSR score
- Each employee can only earn points once per quiz (no duplicate points for retakes)

### Example
- Company has 10 employees
- 7 employees pass the Health & Safety quiz (80%+ score)
- Company earns 7 CSR points for that quiz

---

## User Flow

### Quiz Generation (Automatic)
1. Company owner uploads Health & Safety Manual or Company Policy document
2. System uses AI (Gemini) to read the document
3. AI generates 20 multiple choice questions based on content
4. Quiz is stored and made available to all employees

### Employee Taking Quiz (Optional)
1. Employee sees available quizzes in their portal
2. Employee clicks to start quiz
3. 20 questions displayed (one at a time or all at once)
4. Employee submits answers
5. System grades quiz immediately
6. If 80%+ correct: Success message, CSR point awarded
7. If below 80%: Fail message, option to retry

---

## Technical Requirements

### Database Schema
- `document_quizzes` table:
  - id, companyId, documentId, documentType
  - questions (JSON array of question objects)
  - createdAt, updatedAt
  
- `quiz_attempts` table:
  - id, quizId, employeeId, companyId
  - score (percentage)
  - passed (boolean)
  - answers (JSON array of selected answers)
  - completedAt

### Question Object Format
```json
{
  "questionNumber": 1,
  "question": "What is the primary purpose of the lockout/tagout procedure?",
  "options": {
    "A": "To save energy",
    "B": "To prevent accidental equipment startup during maintenance",
    "C": "To track equipment usage",
    "D": "To schedule maintenance"
  },
  "correctAnswer": "B"
}
```

### API Endpoints
1. `POST /api/quiz/generate/:documentId` - Generate quiz from document (AI)
2. `GET /api/quiz/available` - Get available quizzes for current employee
3. `GET /api/quiz/:quizId` - Get quiz questions (without answers)
4. `POST /api/quiz/:quizId/submit` - Submit quiz answers, get results
5. `GET /api/quiz/:quizId/results` - Get employee's quiz results

### AI Integration
- Use Gemini AI to read document content
- Prompt AI to generate exactly 20 questions with 4 options each
- Validate AI response format before storing
- Handle PDF/document parsing

---

## Business Logic

### Quiz Generation Trigger
- Automatically triggered when Health & Safety Manual or Company Policy is uploaded
- Can be manually re-triggered if document is updated/replaced

### Attempt Tracking
- Track all attempts (passed and failed)
- Only first passing attempt counts for CSR points
- Allow unlimited retries

### CSR Integration
- Add quiz points as a new category in CSR calculation
- Formula: Quiz Points = (Employees who passed / Total employees) per quiz type
- Max points = number of employees × number of quiz types (2)

---

## Edge Cases to Handle
- Document is too short for 20 questions → Generate as many as possible, minimum 10
- AI fails to generate quiz → Show error, allow manual retry
- Document is replaced → Generate new quiz, reset all attempt records
- Employee has already passed → Show "Completed" badge, no retake needed
- Quiz in progress when document replaced → Allow completion, new quiz available after

---

## Testing Strategy
1. Upload Health & Safety Manual → Verify 20 questions generated
2. Upload Company Policy → Verify 20 questions generated
3. Employee takes quiz, scores 80%+ → Verify CSR point awarded
4. Employee takes quiz, scores below 80% → Verify no point, retry available
5. Multiple employees pass → Verify correct CSR point total
6. Document replaced → Verify new quiz generated
