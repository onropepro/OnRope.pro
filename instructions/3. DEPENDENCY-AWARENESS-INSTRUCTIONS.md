# Dependency-Aware Development: Overarching Principles & Mandatory Workflow

**Version**: 1.0  
**Last Updated**: November 22, 2024  
**Status**: ACTIVE - FOUNDATIONAL DOCUMENT

## 1. Why This Exists

The Rope Access Management System operates as a tightly coupled ecosystem where changes in one feature produce **ripple effects** across work sessions, safety documentation, payroll calculations, gear tracking, and multi-tenant boundaries. With field workers depending on this system for safety-critical operations and accurate time tracking, **local fixes without system-wide awareness are prohibited**.

**Zero tolerance for errors** under the "It Just Works" principle requires every change to be evaluated for impacts on:
- Work session tracking and GPS validation
- Safety documentation and compliance records
- Time calculations and payroll processing
- Multi-tenant data isolation
- Gear inventory and inspection workflows
- Project progress and drop tracking
- Resident complaints and work orders
- Employee certifications and permissions
- Document generation and storage
- Notification systems and alerts

## 2. System Dependency Map

### Core Dependency Chains

```
┌─────────────────────────── WORK FLOW ───────────────────────────┐
│                                                                  │
│  Work Session → GPS Check-in → Drop Tracking → Project Progress │
│       ↓              ↓              ↓                ↓          │
│   Time Entry → Hours Calc → Timesheet → Payroll → Invoicing    │
│       ↓              ↓              ↓                ↓          │
│   Employee → Permissions → Projects → Clients → Billing         │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘

┌─────────────────────────── SAFETY FLOW ─────────────────────────┐
│                                                                  │
│  Inspection → Validation → PDF Gen → Storage → Compliance       │
│       ↓            ↓           ↓         ↓           ↓          │
│   FLHA Form → Signatures → Archive → Audit Trail → Reports     │
│       ↓            ↓           ↓         ↓           ↓          │
│  Toolbox → Team Sign-off → Records → Analytics → Alerts        │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘

┌─────────────────────────── GEAR FLOW ───────────────────────────┐
│                                                                  │
│  Equipment → Daily Check → Pass/Fail → Maintenance → Retirement │
│       ↓           ↓            ↓           ↓            ↓       │
│  Assignment → Employee → Project → Usage → Service Schedule     │
│       ↓           ↓            ↓           ↓            ↓       │
│  Tracking → History → Compliance → Reporting → Replacement     │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

### Cross-System Integration Points

| System A | System B | Integration Type | Critical Invariants |
|----------|----------|------------------|-------------------|
| Work Sessions | Projects | Drop updates | Total drops must match sum of sessions |
| Work Sessions | Timesheets | Hour calculation | No time can be lost or duplicated |
| Work Sessions | GPS | Location validation | Start/end locations required |
| Inspections | Work Sessions | Pre-work requirement | No work without inspection |
| Employees | Projects | Assignment | Only assigned employees can log work |
| Employees | Companies | Multi-tenant | Strict company isolation |
| Gear | Inspections | Equipment check | Failed gear blocks work |
| Complaints | Projects | Work generation | Complaints create work orders |
| Documents | Object Storage | File persistence | Never use local storage |
| Payroll | Pay Periods | Calculation timing | Period boundaries immutable |

## 3. Canonical Order of Operations

The system MUST follow these sequences for critical workflows:

### Work Session Flow
1. **Employee authentication** - Verify role and company
2. **Project validation** - Confirm assignment
3. **Safety inspection** - Complete harness/equipment check
4. **GPS capture** - Record start location
5. **Session creation** - Initialize with timestamp
6. **Drop tracking** - Update per elevation
7. **Session closure** - End time and location
8. **Hours calculation** - Regular/OT/DT breakdown
9. **Progress update** - Project completion percentage
10. **Sync to cloud** - Ensure persistence

### Safety Documentation Flow
1. **Form selection** - FLHA, Toolbox, Inspection
2. **Data entry** - Required fields validation
3. **Team participation** - Multi-employee input
4. **Digital signatures** - Legally binding capture
5. **PDF generation** - Immutable document creation
6. **Object storage** - Permanent file storage
7. **Database record** - Metadata and references
8. **Compliance tracking** - Regulatory requirements
9. **Alert generation** - Notifications if needed
10. **Audit logging** - Complete trail

### Payroll Processing Flow
1. **Period determination** - Based on company config
2. **Session aggregation** - Collect all work sessions
3. **Hours summation** - By day and week
4. **Overtime calculation** - Apply thresholds
5. **Rate application** - Employee hourly rates
6. **Timesheet generation** - Official record
7. **Approval workflow** - Manager sign-off
8. **Export preparation** - Accounting system format
9. **Archive creation** - Permanent record
10. **Payment processing** - Integration with payroll

## 4. Non-Negotiable Invariants

These rules MUST be maintained across all system changes:

### Multi-Tenant Isolation
- **Company data MUST be isolated** - No cross-company access ever
- **Queries MUST filter by companyId** - Every database query
- **Employees see only assigned projects** - Role-based filtering
- **Residents access only linked company** - Via unique codes
- **Documents scoped to company** - Complete separation

### Work Session Integrity
- **GPS coordinates MUST be captured** - Start and end locations
- **Time MUST use server timestamps** - Never trust client
- **Drops MUST be tracked per elevation** - N/E/S/W separately
- **Hours MUST calculate correctly** - Regular before OT before DT
- **Sessions MUST be immutable once approved** - No retroactive changes

### Safety Compliance
- **Inspections MUST precede work** - Block work without inspection
- **Signatures MUST be captured** - Legal requirement
- **Documents MUST be permanent** - No deletion, only archival
- **Failed equipment MUST block usage** - Safety override
- **Certifications MUST be current** - Expiry validation

### Data Integrity
- **Transactions MUST be atomic** - All or nothing
- **Files MUST use Object Storage** - Never local filesystem
- **Calculations MUST be idempotent** - Same result every time
- **Status transitions MUST be valid** - Defined state machine
- **Audit trails MUST be complete** - Every change logged

## 5. System Impact Scan (Required Before ANY Change)

Complete this comprehensive checklist before modifying any code:

### File Impact Analysis
```markdown
## Impact Scan Checklist

### Database Impact
- [ ] List all tables that will be read
- [ ] List all tables that will be modified
- [ ] Identify foreign key relationships
- [ ] Check for cascade effects
- [ ] Verify index usage

### API Impact
- [ ] List all endpoints affected
- [ ] Identify parameter changes
- [ ] Check response format changes
- [ ] Verify backwards compatibility
- [ ] Test error responses

### UI Impact
- [ ] List all components affected
- [ ] Check mobile responsiveness
- [ ] Verify offline functionality
- [ ] Test loading states
- [ ] Confirm error handling

### Multi-Tenant Impact
- [ ] Verify companyId filtering
- [ ] Check permission boundaries
- [ ] Test role-based access
- [ ] Confirm data isolation
- [ ] Validate cross-tenant safety

### Integration Impact
- [ ] Work session calculations
- [ ] Safety documentation flow
- [ ] Payroll processing
- [ ] Project progress tracking
- [ ] Notification systems

### Performance Impact
- [ ] Query execution time
- [ ] Memory usage
- [ ] Network requests
- [ ] Offline storage
- [ ] Sync operations
```

## 6. Change Manifest Template

Include this in EVERY pull request or significant change:

```markdown
# Change Manifest

## Scope
- **Feature/Bug**: [Description]
- **Entry Points**: [Modified endpoints/components]
- **User Roles Affected**: [Which roles see changes]

## Dependency Map
- **Upstream Dependencies**: [Systems that feed this change]
- **Downstream Dependencies**: [Systems consuming output]
- **Parallel Systems**: [Systems running alongside]

## Multi-Tenant Verification
- [ ] CompanyId filtering maintained
- [ ] No cross-company data leakage
- [ ] Role permissions respected
- [ ] Resident isolation intact
- [ ] Admin boundaries enforced

## Safety System Impact
- [ ] Work session integrity maintained
- [ ] Inspection workflows unaffected
- [ ] GPS tracking still functional
- [ ] Digital signatures working
- [ ] Compliance reporting accurate

## Invariants Verified
- [ ] GPS coordinates captured correctly
- [ ] Time calculations accurate
- [ ] Drops tracked per elevation
- [ ] Multi-tenant isolation confirmed
- [ ] Object Storage used for files
- [ ] Audit trail complete
- [ ] Status transitions valid
- [ ] Safety blocks enforced
- [ ] Certification checks working
- [ ] Payroll calculations correct

## Testing Coverage
- **Unit Tests**: [New/modified test files]
- **Integration Tests**: [End-to-end scenarios]
- **Multi-Tenant Tests**: [Isolation verification]
- **Field Tests**: [Mobile/offline scenarios]
- **Performance Tests**: [Load/timing results]

## Rollback Plan
- **Database**: [How to revert schema changes]
- **Code**: [Commit to revert to]
- **Data**: [How to restore if corrupted]
```

## 7. Critical Integration Test Matrix

Run these tests for ANY change affecting core systems:

| Test Case | Work Sessions | Safety Docs | Gear Tracking | Payroll | Multi-Tenant | Expected Result |
|-----------|--------------|-------------|---------------|---------|--------------|-----------------|
| Start work without inspection | ✓ | ✓ | - | - | ✓ | Blocked - inspection required |
| Clock in with GPS disabled | ✓ | - | - | - | ✓ | Warning - manual entry required |
| Log drops across elevations | ✓ | - | - | - | ✓ | Each elevation tracked separately |
| Submit work > 8 hours | ✓ | - | - | ✓ | ✓ | OT hours calculated correctly |
| Fail equipment inspection | - | ✓ | ✓ | - | ✓ | Equipment marked unavailable |
| Complete FLHA form | - | ✓ | - | - | ✓ | PDF generated and stored |
| Multiple employees sign | - | ✓ | - | - | ✓ | All signatures captured |
| Cross-company data access | ✓ | ✓ | ✓ | ✓ | ✓ | Access denied - isolation working |
| Offline work session | ✓ | - | - | - | ✓ | Syncs when reconnected |
| Retroactive timesheet edit | ✓ | - | - | ✓ | ✓ | Blocked if approved |

## 8. Performance & Scalability Requirements

Every change MUST maintain these performance standards:

### Response Time Requirements
- **API Endpoints**: < 500ms for standard queries
- **Work Session Start**: < 2 seconds including GPS
- **Drop Updates**: < 1 second per update
- **Report Generation**: < 10 seconds for monthly
- **PDF Creation**: < 3 seconds per document
- **Search Operations**: < 1 second for results

### Scalability Targets
- **Concurrent Users**: 1000+ active sessions
- **Daily Work Sessions**: 10,000+ entries
- **Monthly Timesheets**: 100,000+ records
- **Document Storage**: 1M+ files retained
- **Audit Records**: 10M+ log entries

### Offline Capabilities
- **Work Sessions**: Full offline support
- **Safety Forms**: Create offline, sync later
- **Drop Tracking**: Queue updates locally
- **GPS Capture**: Store for later upload
- **Photo Storage**: Local until synced

## 9. Observability & Monitoring

### Required Logging
```typescript
// Every critical operation must log:
logger.info({
  action: 'work_session_start',
  userId: employee.id,
  companyId: company.id,
  projectId: project.id,
  gpsLat: startLatitude,
  gpsLng: startLongitude,
  timestamp: new Date(),
  deviceInfo: userAgent
});
```

### Critical Alerts
- **Failed GPS capture** - Affects billing accuracy
- **Inspection not completed** - Safety violation
- **Cross-company access attempt** - Security breach
- **Work session > 16 hours** - Possible error
- **Drops exceed daily target by 200%** - Data issue
- **Timesheet calculation mismatch** - Payroll error
- **Object Storage failure** - Document loss risk
- **Sync queue > 100 items** - Connectivity issue

### Dashboard Metrics
- Work sessions active
- Daily drops by project
- Safety compliance rate
- Equipment failure rate
- Sync queue depth
- API response times
- Error rates by type
- Storage usage

## 10. Anti-Patterns (Zero Tolerance)

### Prohibited Practices
❌ **Making isolated changes** - Not checking system-wide impact
❌ **Skipping multi-tenant checks** - Assuming companyId filtering
❌ **Trusting client timestamps** - Using device time for records
❌ **Storing files locally** - Not using Object Storage
❌ **Hard deleting records** - Removing audit trail
❌ **Calculating on frontend** - Payroll/hours calculations
❌ **Bypassing safety checks** - Allowing work without inspection
❌ **Ignoring GPS requirements** - Not capturing location
❌ **Modifying approved records** - Changing historical data
❌ **Cross-company queries** - Accessing other company data

### Required Practices
✅ **Complete impact analysis** - Use system scan checklist
✅ **Filter by companyId always** - Every query, every time
✅ **Use server timestamps** - For all time records
✅ **Store in Object Storage** - All persistent files
✅ **Soft delete with audit** - Maintain history
✅ **Calculate on backend** - All critical math
✅ **Enforce safety blocks** - No exceptions
✅ **Require GPS capture** - For work sessions
✅ **Lock approved records** - Immutable history
✅ **Isolate company data** - Complete separation

## 11. Emergency Procedures

### If Multi-Tenant Breach Detected
1. **Immediately isolate** - Disable affected endpoints
2. **Audit all access** - Last 24 hours of queries
3. **Identify scope** - Which companies affected
4. **Lock accounts** - Prevent further access
5. **Notify security** - Escalate immediately
6. **Review code** - Find and fix vulnerability
7. **Test isolation** - Verify fix works
8. **Document incident** - Complete report

### If Work Session Data Lost
1. **Stop new sessions** - Prevent more loss
2. **Check sync queue** - Look for pending data
3. **Review device storage** - Check for local copies
4. **Query audit logs** - Reconstruct from logs
5. **Validate GPS records** - Cross-reference location
6. **Restore from backup** - If available
7. **Manual entry** - Last resort with approval
8. **Prevent recurrence** - Fix root cause

### If Safety Document Missing
1. **Block related work** - Safety first
2. **Check Object Storage** - Verify file exists
3. **Review database** - Check references
4. **Regenerate if possible** - From source data
5. **Require re-inspection** - If cannot recover
6. **Document incident** - Compliance requirement
7. **Update procedures** - Prevent repeat

## 12. Continuous Improvement

### Code Review Checklist
- [ ] System impact scan completed
- [ ] Change manifest filled out
- [ ] Multi-tenant isolation verified
- [ ] Safety invariants maintained
- [ ] Performance requirements met
- [ ] Offline functionality preserved
- [ ] Test coverage adequate
- [ ] Documentation updated
- [ ] Monitoring added
- [ ] Rollback plan defined

### Regular Audits
- **Weekly**: Multi-tenant isolation tests
- **Monthly**: Performance benchmarks
- **Quarterly**: Safety compliance review
- **Annually**: Full dependency mapping

### Documentation Maintenance
- Update when dependencies change
- Add new integration points
- Record incident learnings
- Share pattern discoveries
- Maintain troubleshooting guides

---

## Critical Reminder: Lives and Livelihoods Depend on This System

Every change you make affects:
- **Worker Safety**: Inspections, equipment tracking, emergency contacts
- **Fair Pay**: Accurate time tracking, proper overtime calculation
- **Regulatory Compliance**: Safety documentation, audit trails
- **Business Operations**: Project tracking, client billing
- **Data Security**: Multi-tenant isolation, privacy protection

**Think globally. Test thoroughly. Deploy carefully.**

**Every line of code has system-wide implications.**

This dependency-aware framework ensures the Rope Access Management System maintains its "It Just Works" standard across all features, all companies, and all field operations. No exceptions.