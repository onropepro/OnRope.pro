# Dependency-Aware Development: Overarching Principles & Mandatory Workflow

**Version**: 2.0  
**Last Updated**: November 30, 2025  
**Status**: ACTIVE - FOUNDATIONAL DOCUMENT

## 1. Why This Exists

The Rope Access Management System operates as a tightly coupled ecosystem where changes in one feature produce **ripple effects** across work sessions, safety documentation, payroll calculations, gear tracking, subscription management, and multi-tenant boundaries. With field workers depending on this system for safety-critical operations and accurate time tracking, **local fixes without system-wide awareness are prohibited**.

**Zero tolerance for errors** under the "It Just Works" principle requires every change to be evaluated for impacts on:
- Work session tracking and GPS validation
- Safety documentation and compliance records
- Time calculations and payroll processing
- Multi-tenant data isolation
- Gear inventory and inspection workflows
- Project progress and drop tracking
- Resident complaints and work orders
- Employee certifications and permissions
- Document generation and storage
- Notification systems and alerts
- Subscription management and billing
- Quote/CRM pipeline operations
- Property manager vendor relationships
- IRATA task logging and certification tracking
- Company Safety Rating (CSR) calculations
- Feature request communication
- SuperUser metrics and analytics

## 2. System Dependency Map

### Core Dependency Chains

```
┌─────────────────────────── WORK FLOW ───────────────────────────┐
│                                                                  │
│  Work Session → GPS Check-in → Drop Tracking → Project Progress │
│       ↓              ↓              ↓                ↓          │
│   Time Entry → Hours Calc → Timesheet → Payroll → Invoicing    │
│       ↓              ↓              ↓                ↓          │
│   Employee → Permissions → Projects → Clients → Billing         │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘

┌─────────────────────────── SAFETY FLOW ─────────────────────────┐
│                                                                  │
│  Inspection → Validation → PDF Gen → Storage → Compliance       │
│       ↓            ↓           ↓         ↓           ↓          │
│   FLHA Form → Signatures → Archive → Audit Trail → Reports     │
│       ↓            ↓           ↓         ↓           ↓          │
│  Toolbox → Team Sign-off → Records → Analytics → Alerts        │
│       ↓            ↓           ↓         ↓           ↓          │
│  Incident → Investigation → Corrective → Regulatory → Review   │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘

┌─────────────────────────── GEAR FLOW ───────────────────────────┐
│                                                                  │
│  Equipment → Daily Check → Pass/Fail → Maintenance → Retirement │
│       ↓           ↓            ↓           ↓            ↓       │
│  Assignment → Employee → Project → Usage → Service Schedule     │
│       ↓           ↓            ↓           ↓            ↓       │
│  Tracking → History → Compliance → Reporting → Replacement     │
│       ↓           ↓            ↓           ↓            ↓       │
│  Damage Rpt → Investigation → Repair/Replace → Inventory Adj   │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘

┌─────────────────────────── QUOTE/CRM FLOW ──────────────────────┐
│                                                                  │
│  Client → Building → Contact Info → Rate Card → CRM Stage       │
│       ↓        ↓           ↓            ↓           ↓           │
│   Quote → Services → Labor Calc → Tax Compute → PDF Generation │
│       ↓        ↓           ↓            ↓           ↓           │
│  Approval → Project → Schedule → Work Orders → Invoicing       │
│       ↓        ↓           ↓            ↓           ↓           │
│  History → Follow-up → Renewal → Client Retention → Analytics  │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘

┌─────────────────────────── SUBSCRIPTION FLOW ───────────────────┐
│                                                                  │
│  Company → License Key → Tier Selection → Stripe Checkout       │
│       ↓          ↓             ↓               ↓                │
│  Payment → Webhook → Tier Limits → Feature Access → Add-ons    │
│       ↓          ↓             ↓               ↓        ↓       │
│  Seats → Projects → White Label → MRR Tracking → Churn Monitor │
│       ↓          ↓             ↓               ↓        ↓       │
│  Upgrade → Proration → License Regen → Limit Update → Billing  │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘

┌─────────────────────────── PROPERTY MANAGER FLOW ───────────────┐
│                                                                  │
│  PM Account → Unique Code → Company Link → Strata Number        │
│       ↓            ↓             ↓              ↓               │
│  Vendor List → Project Access → Read-Only View → CSR Access    │
│       ↓            ↓             ↓              ↓               │
│  Documents → Anchor Certs → Progress Photos → Compliance View  │
│       ↓            ↓             ↓              ↓               │
│  Isolation → Role Guards → API Blocks → Route Protection       │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘

┌─────────────────────────── IRATA CERTIFICATION FLOW ────────────┐
│                                                                  │
│  Work Session → End Session → Task Selection → Task Logging     │
│       ↓              ↓             ↓              ↓             │
│  Canonical Tasks → Server Metadata → Hours Capture → Building  │
│       ↓              ↓             ↓              ↓             │
│  Logbook Entry → History View → Statistics → Export Ready      │
│       ↓              ↓             ↓              ↓             │
│  Cert Tracking → Expiry Alerts → Level Progress → Compliance   │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘

┌─────────────────────────── DOCUMENT REVIEW FLOW ────────────────┐
│                                                                  │
│  Company Docs → Employee Enrollment → Pending Status            │
│       ↓              ↓                    ↓                     │
│  View Tracking → viewedAt Timestamp → Read Confirmation         │
│       ↓              ↓                    ↓                     │
│  Signature → Canvas Capture → signedAt Timestamp → Data URL     │
│       ↓              ↓                    ↓           ↓         │
│  Compliance → CSR Component → Audit Trail → PDF Embed Ready    │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘

┌─────────────────────────── CSR (COMPANY SAFETY RATING) FLOW ────┐
│                                                                  │
│  Base Score (100%) → Documentation Check → Penalty Calculation  │
│       ↓                    ↓                     ↓              │
│  Toolbox Coverage → 7-Day Window → Work Session Matching        │
│       ↓                    ↓                     ↓              │
│  Harness Inspections → Completion Rate → Penalty Application    │
│       ↓                    ↓                     ↓              │
│  Doc Reviews → Signature Status → Penalty Calculation           │
│       ↓                    ↓                     ↓              │
│  Final Score → PM Visibility → Vendor Comparison → Compliance   │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘

┌─────────────────────────── FEATURE REQUEST FLOW ────────────────┐
│                                                                  │
│  Company Owner → Request Submission → Category/Priority         │
│       ↓                ↓                    ↓                   │
│  SuperUser View → Status Update → Two-Way Messaging             │
│       ↓                ↓                    ↓                   │
│  Read Tracking → Notification → Resolution → Implementation    │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘

┌─────────────────────────── SUPERUSER METRICS FLOW ──────────────┐
│                                                                  │
│  MRR Snapshots → Daily Capture → Tier Breakdown → Movement      │
│       ↓              ↓               ↓              ↓           │
│  Customer Health → Usage Scoring → Login Tracking → Risk Status │
│       ↓              ↓               ↓              ↓           │
│  Churn Events → Reason Tracking → Win-back Monitor → Analytics │
│       ↓              ↓               ↓              ↓           │
│  Gift Accounts → Add-on Gifting → License Mgmt → Company View  │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘

┌─────────────────────────── SCHEDULING FLOW ─────────────────────┐
│                                                                  │
│  Scheduled Job → Project Link → Employee Assignments            │
│       ↓              ↓               ↓                          │
│  Date Ranges → Start/End Dates → Conflict Detection             │
│       ↓              ↓               ↓                          │
│  Calendar View → Resource Timeline → Drag-Drop Assignment       │
│       ↓              ↓               ↓                          │
│  Notifications → Employee Alert → Supervisor View               │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘

┌─────────────────────────── NON-BILLABLE SESSION FLOW ───────────┐
│                                                                  │
│  Clock In → Category Selection → GPS Capture → Session Start    │
│       ↓           ↓                  ↓             ↓            │
│  Notes Entry → Time Tracking → Clock Out → Overtime Calc        │
│       ↓           ↓                  ↓             ↓            │
│  Payroll Include → Timesheet → Hours Report → Cost Analysis     │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

### Cross-System Integration Points

| System A | System B | Integration Type | Critical Invariants |
|----------|----------|------------------|-------------------|
| Work Sessions | Projects | Drop updates | Total drops must match sum of sessions |
| Work Sessions | Timesheets | Hour calculation | No time can be lost or duplicated |
| Work Sessions | GPS | Location validation | Start/end locations required |
| Work Sessions | IRATA Tasks | Task logging trigger | Task log only after session end |
| Inspections | Work Sessions | Pre-work requirement | No work without inspection |
| Employees | Projects | Assignment | Only assigned employees can log work |
| Employees | Companies | Multi-tenant | Strict company isolation |
| Employees | Document Reviews | Compliance tracking | All enrolled docs must be signed |
| Gear | Inspections | Equipment check | Failed gear blocks work |
| Gear | Damage Reports | Condition tracking | Damage links to specific item |
| Complaints | Projects | Work generation | Complaints create work orders |
| Documents | Object Storage | File persistence | Never use local storage |
| Payroll | Pay Periods | Calculation timing | Period boundaries immutable |
| Payroll | Non-Billable Sessions | Hour inclusion | Non-billable hours in payroll reports |
| Quotes | Projects | Conversion | Quote services map to project scope |
| Quotes | Clients | CRM stage | Pipeline stage drives workflow |
| Subscriptions | Stripe | Payment processing | Webhook must update DB atomically |
| Subscriptions | Tier Limits | Feature gating | Seats/projects enforced at tier level |
| Subscriptions | White Label | Branding activation | CSS variables from hex to HSL |
| Property Managers | Company Links | Vendor access | Strata number required for data access |
| Property Managers | CSR | Rating visibility | Read-only CSR with breakdown |
| IRATA Tasks | Work Sessions | Metadata derivation | Hours/dates from server, not client |
| IRATA Tasks | Canonical List | Task validation | Only predefined task types allowed |
| Document Reviews | CSR | Compliance component | Unsigned docs penalize CSR |
| Toolbox Meetings | CSR | Coverage calculation | 7-day window for work session coverage |
| Toolbox Meetings | Signatures | Attendance proof | All attendees must sign |
| Feature Requests | Messages | Communication | Two-way company-superuser messaging |
| MRR Snapshots | Subscriptions | Revenue tracking | Daily snapshot of all tiers |
| Customer Health | Usage Metrics | Churn prediction | Score based on login/usage/payment |
| Scheduled Jobs | Employees | Assignment dates | Date ranges per employee |
| Incident Reports | Regulatory | Compliance | WorkSafeBC fields, supervisor review |
| Method Statements | Projects | Safety documentation | Project-specific safety procedures |
| User Preferences | Dashboard | Card ordering | Persisted drag-drop order |
| i18n | User Settings | Language | User language preference stored |

## 3. Canonical Order of Operations

The system MUST follow these sequences for critical workflows:

### Work Session Flow
1. **Employee authentication** - Verify role and company
2. **Project validation** - Confirm assignment
3. **Safety inspection** - Complete harness/equipment check
4. **GPS capture** - Record start location
5. **Session creation** - Initialize with timestamp
6. **Drop tracking** - Update per elevation
7. **Session closure** - End time and location
8. **Hours calculation** - Regular/OT/DT breakdown
9. **IRATA task prompt** - For IRATA technicians only
10. **Progress update** - Project completion percentage
11. **Sync to cloud** - Ensure persistence

### Safety Documentation Flow
1. **Form selection** - FLHA, Toolbox, Inspection, Incident, Method Statement
2. **Data entry** - Required fields validation
3. **Team participation** - Multi-employee input
4. **Digital signatures** - Legally binding capture
5. **PDF generation** - Immutable document creation
6. **Object storage** - Permanent file storage
7. **Database record** - Metadata and references
8. **Compliance tracking** - Regulatory requirements
9. **CSR impact** - Update safety rating components
10. **Alert generation** - Notifications if needed
11. **Audit logging** - Complete trail

### Payroll Processing Flow
1. **Period determination** - Based on company config
2. **Session aggregation** - Collect all work sessions
3. **Non-billable inclusion** - Add non-billable sessions
4. **Hours summation** - By day and week
5. **Overtime calculation** - Apply thresholds (8hr/40hr)
6. **Rate application** - Employee hourly rates
7. **Timesheet generation** - Official record
8. **Approval workflow** - Manager sign-off
9. **Export preparation** - Accounting system format
10. **Archive creation** - Permanent record
11. **Payment processing** - Integration with payroll

### Quote Generation Flow
1. **Client selection** - Existing or new client
2. **Building identification** - Address and details
3. **Service selection** - From predefined or custom
4. **Labor calculation** - Hours × rate × employees
5. **Tax computation** - Based on jurisdiction
6. **Quote assembly** - Services + totals
7. **PDF generation** - Professional format
8. **Email delivery** - If Resend configured
9. **CRM stage update** - Pipeline tracking
10. **Follow-up scheduling** - If not converted

### Document Review & Signature Flow
1. **Admin document upload** - Health & Safety, Policies, etc.
2. **Employee enrollment** - Individual or bulk
3. **Pending status creation** - documentReviewSignatures record
4. **Employee notification** - Document awaiting review
5. **Document viewing** - viewedAt timestamp capture
6. **Signature capture** - Canvas-based digital signature
7. **signedAt recording** - Legal timestamp
8. **Signature storage** - Base64 data URL
9. **CSR recalculation** - Update document review component
10. **Audit trail update** - Complete compliance record

### Property Manager Vendor Linking Flow
1. **PM account creation** - property_manager role
2. **Unique code generation** - propertyManagerCode on company
3. **Link request** - PM enters company code
4. **Strata number entry** - Required for data isolation
5. **Link creation** - propertyManagerCompanyLinks record
6. **Vendor list access** - My Vendors dashboard
7. **Project visibility** - Filtered by strata number
8. **CSR access** - Read-only vendor safety rating
9. **Document access** - Anchor certs, photos (read-only)
10. **Route protection** - Blocked from employee features

### IRATA Task Logging Flow
1. **Work session end** - Employee completes work
2. **Role check** - Only IRATA technicians proceed
3. **Task selection dialog** - Multi-select from canonical list
4. **Metadata derivation** - Hours/date from work session (server)
5. **Building info capture** - From project record
6. **Log creation** - irataTaskLogs record
7. **Unique constraint** - One log per work session
8. **Logbook display** - My Logged Hours page
9. **Statistics calculation** - Task type breakdown
10. **Export preparation** - Certification documentation

### Subscription Upgrade/Add-on Flow
1. **Current tier check** - Retrieve subscription status
2. **Target tier selection** - User chooses new tier
3. **Proration calculation** - Stripe handles automatically
4. **Payment processing** - Stripe subscription update
5. **License key regeneration** - New tier suffix
6. **Database update** - Via webhook
7. **Limit enforcement** - Seats/projects updated
8. **Feature gating** - Access control refreshed
9. **UI refresh** - Cache invalidation
10. **Confirmation display** - Success message

### CSR Calculation Flow
1. **Base score initialization** - Start at 100%
2. **Documentation check** - COI, H&S Manual, Policy
3. **Documentation penalty** - 25% if any missing
4. **Toolbox coverage calc** - Work sessions in 7-day windows
5. **Toolbox penalty** - Up to 25% based on coverage
6. **Harness inspection calc** - Completion rate
7. **Harness penalty** - Up to 25% based on rate
8. **Document review calc** - Signed vs unsigned docs
9. **Document penalty** - Up to 5% based on signatures
10. **Final score** - 100% minus all penalties (max 80% penalty)

### Incident Report Flow
1. **Report initiation** - Date, time, location capture
2. **Incident classification** - Type, severity, potential severity
3. **Injured person tracking** - Names, injuries, treatment
4. **Root cause analysis** - Categories and details
5. **Corrective actions** - Immediate and preventive
6. **Regulatory fields** - WorkSafeBC claim number if applicable
7. **Supervisor review** - Review date and notes
8. **Management review** - Escalation if needed
9. **Digital signatures** - Preparer and witnesses
10. **PDF generation** - Compliance-ready format

## 4. Non-Negotiable Invariants

These rules MUST be maintained across all system changes:

### Multi-Tenant Isolation
- **Company data MUST be isolated** - No cross-company access ever
- **Queries MUST filter by companyId** - Every database query
- **Employees see only assigned projects** - Role-based filtering
- **Residents access only linked company** - Via unique residentCode
- **Property managers access only linked vendors** - Via propertyManagerCode
- **Documents scoped to company** - Complete separation
- **Strata number required** - PM data access requires building match

### Work Session Integrity
- **GPS coordinates MUST be captured** - Start and end locations
- **Time MUST use server timestamps** - Never trust client
- **Drops MUST be tracked per elevation** - N/E/S/W separately
- **Hours MUST calculate correctly** - Regular before OT before DT
- **Sessions MUST be immutable once approved** - No retroactive changes
- **Non-billable sessions MUST be categorized** - Training, travel, admin, etc.

### Safety Compliance
- **Inspections MUST precede work** - Block work without inspection
- **Signatures MUST be captured** - Legal requirement
- **Documents MUST be permanent** - No deletion, only archival
- **Failed equipment MUST block usage** - Safety override
- **Certifications MUST be current** - Expiry validation
- **Incident reports MUST be complete** - All regulatory fields
- **Toolbox meetings MUST cover work sessions** - 7-day window rule

### IRATA Task Logging
- **Tasks MUST use canonical types** - Only predefined task IDs
- **Metadata MUST derive from server** - Hours/dates from work session
- **One log per work session** - Unique constraint enforced
- **Employee ownership MUST be verified** - Cannot log for others
- **Building info MUST match project** - Server-derived, not client

### Subscription & Billing
- **Tier limits MUST be enforced** - Seats and projects per tier
- **Webhooks MUST be atomic** - All-or-nothing DB updates
- **License keys MUST match tier** - Suffix indicates tier level
- **Proration MUST use Stripe** - No custom calculation
- **White label MUST check subscription** - Only active if paid
- **Add-ons MUST track separately** - Extra seats, projects, branding

### Property Manager Access
- **Code separation MUST be enforced** - PM code ≠ resident code
- **Read-only access MUST be maintained** - No modification rights
- **Route guards MUST block employee routes** - /dashboard, /projects, etc.
- **API permission checks MUST verify role** - Backend enforcement
- **Strata number MUST match** - Data filtered by building

### Document Review & Signatures
- **Signature data MUST be base64** - Canvas capture format
- **viewedAt MUST precede signedAt** - Logical ordering
- **Bulk enrollment MUST be auditable** - Track who enrolled whom
- **Signed documents MUST be immutable** - No post-signature changes
- **CSR penalty MUST reflect status** - Unsigned docs reduce score

### Data Integrity
- **Transactions MUST be atomic** - All or nothing
- **Files MUST use Object Storage** - Never local filesystem
- **Calculations MUST be idempotent** - Same result every time
- **Status transitions MUST be valid** - Defined state machine
- **Audit trails MUST be complete** - Every change logged
- **Cascade deletes MUST be intentional** - Foreign key behavior defined

### CSR Calculation Accuracy
- **Base score MUST start at 100%** - Penalty-based system
- **Maximum penalty MUST be 80%** - Minimum score is 20%
- **Component weights MUST be correct** - Docs 25%, Toolbox 25%, Harness 25%, Reviews 5%
- **7-day window MUST be bidirectional** - Meeting covers ±7 days
- **Project completion MUST be informational** - No penalty impact

## 5. System Impact Scan (Required Before ANY Change)

Complete this comprehensive checklist before modifying any code:

### File Impact Analysis
```markdown
## Impact Scan Checklist

### Database Impact
- [ ] List all tables that will be read
- [ ] List all tables that will be modified
- [ ] Identify foreign key relationships
- [ ] Check for cascade effects
- [ ] Verify index usage
- [ ] Consider migration requirements

### API Impact
- [ ] List all endpoints affected
- [ ] Identify parameter changes
- [ ] Check response format changes
- [ ] Verify backwards compatibility
- [ ] Test error responses
- [ ] Validate permission checks

### UI Impact
- [ ] List all components affected
- [ ] Check mobile responsiveness
- [ ] Verify offline functionality
- [ ] Test loading states
- [ ] Confirm error handling
- [ ] Check dark mode compatibility

### Multi-Tenant Impact
- [ ] Verify companyId filtering
- [ ] Check permission boundaries
- [ ] Test role-based access
- [ ] Confirm data isolation
- [ ] Validate cross-tenant safety
- [ ] Verify property manager isolation

### Subscription Impact
- [ ] Check tier limit enforcement
- [ ] Verify feature gating
- [ ] Test add-on interactions
- [ ] Confirm webhook handling
- [ ] Validate white label behavior

### Integration Impact
- [ ] Work session calculations
- [ ] Safety documentation flow
- [ ] Payroll processing
- [ ] Project progress tracking
- [ ] Notification systems
- [ ] CSR calculation
- [ ] IRATA task logging
- [ ] Quote/CRM pipeline

### Performance Impact
- [ ] Query execution time
- [ ] Memory usage
- [ ] Network requests
- [ ] Offline storage
- [ ] Sync operations
```

## 6. Change Manifest Template

Include this in EVERY pull request or significant change:

```markdown
# Change Manifest

## Scope
- **Feature/Bug**: [Description]
- **Entry Points**: [Modified endpoints/components]
- **User Roles Affected**: [Which roles see changes]

## Dependency Map
- **Upstream Dependencies**: [Systems that feed this change]
- **Downstream Dependencies**: [Systems consuming output]
- **Parallel Systems**: [Systems running alongside]

## Multi-Tenant Verification
- [ ] CompanyId filtering maintained
- [ ] No cross-company data leakage
- [ ] Role permissions respected
- [ ] Resident isolation intact
- [ ] Property manager isolation intact
- [ ] Admin boundaries enforced

## Safety System Impact
- [ ] Work session integrity maintained
- [ ] Inspection workflows unaffected
- [ ] GPS tracking still functional
- [ ] Digital signatures working
- [ ] Compliance reporting accurate
- [ ] CSR calculation correct

## Subscription System Impact
- [ ] Tier limits enforced
- [ ] Webhook handling correct
- [ ] License keys valid
- [ ] Add-ons tracked properly
- [ ] White label functioning

## Invariants Verified
- [ ] GPS coordinates captured correctly
- [ ] Time calculations accurate
- [ ] Drops tracked per elevation
- [ ] Multi-tenant isolation confirmed
- [ ] Object Storage used for files
- [ ] Audit trail complete
- [ ] Status transitions valid
- [ ] Safety blocks enforced
- [ ] Certification checks working
- [ ] Payroll calculations correct
- [ ] IRATA tasks canonical
- [ ] Document signatures captured
- [ ] CSR penalties accurate
- [ ] Subscription limits enforced

## Testing Coverage
- **Unit Tests**: [New/modified test files]
- **Integration Tests**: [End-to-end scenarios]
- **Multi-Tenant Tests**: [Isolation verification]
- **Field Tests**: [Mobile/offline scenarios]
- **Performance Tests**: [Load/timing results]

## Rollback Plan
- **Database**: [How to revert schema changes]
- **Code**: [Commit to revert to]
- **Data**: [How to restore if corrupted]
```

## 7. Critical Integration Test Matrix

Run these tests for ANY change affecting core systems:

| Test Case | Work Sessions | Safety Docs | Gear Tracking | Payroll | Multi-Tenant | Subscription | Expected Result |
|-----------|--------------|-------------|---------------|---------|--------------|--------------|-----------------|
| Start work without inspection | ✓ | ✓ | - | - | ✓ | - | Blocked - inspection required |
| Clock in with GPS disabled | ✓ | - | - | - | ✓ | - | Warning - manual entry required |
| Log drops across elevations | ✓ | - | - | - | ✓ | - | Each elevation tracked separately |
| Submit work > 8 hours | ✓ | - | - | ✓ | ✓ | - | OT hours calculated correctly |
| Fail equipment inspection | - | ✓ | ✓ | - | ✓ | - | Equipment marked unavailable |
| Complete FLHA form | - | ✓ | - | - | ✓ | - | PDF generated and stored |
| Multiple employees sign | - | ✓ | - | - | ✓ | - | All signatures captured |
| Cross-company data access | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ | Access denied - isolation working |
| Offline work session | ✓ | - | - | - | ✓ | - | Syncs when reconnected |
| Retroactive timesheet edit | ✓ | - | - | ✓ | ✓ | - | Blocked if approved |
| Quote service addition | - | - | - | - | ✓ | - | Services saved with quote |
| Quote PDF generation | - | - | - | - | ✓ | - | PDF created with all services |
| PM links with wrong code | - | - | - | - | ✓ | - | Access denied - code mismatch |
| PM accesses employee route | - | - | - | - | ✓ | - | Blocked - route guard active |
| IRATA task with invalid type | ✓ | - | - | - | ✓ | - | Rejected - canonical types only |
| IRATA task duplicate session | ✓ | - | - | - | ✓ | - | Rejected - unique constraint |
| Document sign without view | - | ✓ | - | - | ✓ | - | Rejected - must view first |
| Bulk document enrollment | - | ✓ | - | - | ✓ | - | All employees enrolled |
| Tier upgrade with proration | - | - | - | - | ✓ | ✓ | New tier, prorated charge |
| Add seats beyond tier limit | - | - | - | - | ✓ | ✓ | Blocked - purchase more |
| White label without subscription | - | - | - | - | ✓ | ✓ | Blocked - requires add-on |
| CSR with missing documents | - | ✓ | - | - | ✓ | - | 25% penalty applied |
| Toolbox meeting covers sessions | - | ✓ | - | - | ✓ | - | Sessions within 7 days covered |
| Non-billable session overtime | ✓ | - | - | ✓ | ✓ | - | OT calculated correctly |
| Incident report PDF export | - | ✓ | - | - | ✓ | - | All fields including signatures |
| Equipment damage report | - | - | ✓ | - | ✓ | - | Linked to gear item |
| Feature request messaging | - | - | - | - | ✓ | - | Two-way communication works |
| SuperUser gift account | - | - | - | - | ✓ | ✓ | License activated, tier set |

## 8. Performance & Scalability Requirements

Every change MUST maintain these performance standards:

### Response Time Requirements
- **API Endpoints**: < 500ms for standard queries
- **Work Session Start**: < 2 seconds including GPS
- **Drop Updates**: < 1 second per update
- **Report Generation**: < 10 seconds for monthly
- **PDF Creation**: < 3 seconds per document
- **Search Operations**: < 1 second for results
- **CSR Calculation**: < 2 seconds with all components
- **Quote Generation**: < 3 seconds with services
- **Subscription Status**: < 1 second from Stripe

### Scalability Targets
- **Concurrent Users**: 1000+ active sessions
- **Daily Work Sessions**: 10,000+ entries
- **Monthly Timesheets**: 100,000+ records
- **Document Storage**: 1M+ files retained
- **Audit Records**: 10M+ log entries
- **IRATA Task Logs**: 500,000+ entries
- **Quotes**: 50,000+ per company
- **Subscription Events**: 10,000+ webhook events/day

### Offline Capabilities
- **Work Sessions**: Full offline support
- **Safety Forms**: Create offline, sync later
- **Drop Tracking**: Queue updates locally
- **GPS Capture**: Store for later upload
- **Photo Storage**: Local until synced

## 9. Observability & Monitoring

### Required Logging
```typescript
// Every critical operation must log:
logger.info({
  action: 'work_session_start',
  userId: employee.id,
  companyId: company.id,
  projectId: project.id,
  gpsLat: startLatitude,
  gpsLng: startLongitude,
  timestamp: new Date(),
  deviceInfo: userAgent
});
```

### Critical Alerts
- **Failed GPS capture** - Affects billing accuracy
- **Inspection not completed** - Safety violation
- **Cross-company access attempt** - Security breach
- **Work session > 16 hours** - Possible error
- **Drops exceed daily target by 200%** - Data issue
- **Timesheet calculation mismatch** - Payroll error
- **Object Storage failure** - Document loss risk
- **Sync queue > 100 items** - Connectivity issue
- **Stripe webhook failure** - Payment processing risk
- **Subscription payment failure** - Revenue impact
- **IRATA certification expiring** - Compliance risk (30/14/7 day warnings)
- **Document signature overdue** - Compliance gap
- **CSR drops below 70%** - Safety concern
- **Property manager unauthorized access** - Security issue
- **License key mismatch** - Account integrity issue
- **Feature request unread > 48 hours** - Response SLA
- **Customer health score critical** - Churn risk

### Dashboard Metrics
- Work sessions active
- Daily drops by project
- Safety compliance rate
- Equipment failure rate
- Sync queue depth
- API response times
- Error rates by type
- Storage usage
- Active subscriptions by tier
- MRR and growth rate
- Churn rate
- CSR distribution
- IRATA task logging rate
- Document review completion rate
- Quote conversion rate
- Feature request resolution time

## 10. Anti-Patterns (Zero Tolerance)

### Prohibited Practices
❌ **Making isolated changes** - Not checking system-wide impact
❌ **Skipping multi-tenant checks** - Assuming companyId filtering
❌ **Trusting client timestamps** - Using device time for records
❌ **Storing files locally** - Not using Object Storage
❌ **Hard deleting records** - Removing audit trail
❌ **Calculating on frontend** - Payroll/hours calculations
❌ **Bypassing safety checks** - Allowing work without inspection
❌ **Ignoring GPS requirements** - Not capturing location
❌ **Modifying approved records** - Changing historical data
❌ **Cross-company queries** - Accessing other company data
❌ **Custom proration logic** - Not using Stripe's calculation
❌ **Client-derived IRATA metadata** - Not using server data
❌ **Accepting non-canonical tasks** - Allowing free-form task types
❌ **Signature without view** - Skipping viewedAt requirement
❌ **PM with employee access** - Not enforcing role separation

### Required Practices
✅ **Complete impact analysis** - Use system scan checklist
✅ **Filter by companyId always** - Every query, every time
✅ **Use server timestamps** - For all time records
✅ **Store in Object Storage** - All persistent files
✅ **Soft delete with audit** - Maintain history
✅ **Calculate on backend** - All critical math
✅ **Enforce safety blocks** - No exceptions
✅ **Require GPS capture** - For work sessions
✅ **Lock approved records** - Immutable history
✅ **Isolate company data** - Complete separation
✅ **Use Stripe for billing** - All subscription logic
✅ **Derive IRATA metadata server-side** - Authoritative source
✅ **Validate canonical task types** - Predefined list only
✅ **Enforce view before sign** - Audit trail requirement
✅ **Separate PM from employee features** - Role-based routing

## 11. Emergency Procedures

### If Multi-Tenant Breach Detected
1. **Immediately isolate** - Disable affected endpoints
2. **Audit all access** - Last 24 hours of queries
3. **Identify scope** - Which companies affected
4. **Lock accounts** - Prevent further access
5. **Notify security** - Escalate immediately
6. **Review code** - Find and fix vulnerability
7. **Test isolation** - Verify fix works
8. **Document incident** - Complete report

### If Work Session Data Lost
1. **Stop new sessions** - Prevent more loss
2. **Check sync queue** - Look for pending data
3. **Review device storage** - Check for local copies
4. **Query audit logs** - Reconstruct from logs
5. **Validate GPS records** - Cross-reference location
6. **Restore from backup** - If available
7. **Manual entry** - Last resort with approval
8. **Prevent recurrence** - Fix root cause

### If Safety Document Missing
1. **Block related work** - Safety first
2. **Check Object Storage** - Verify file exists
3. **Review database** - Check references
4. **Regenerate if possible** - From source data
5. **Require re-inspection** - If cannot recover
6. **Document incident** - Compliance requirement
7. **Update procedures** - Prevent repeat

### If Subscription Webhook Fails
1. **Check Stripe dashboard** - Verify event sent
2. **Review webhook logs** - Identify error
3. **Verify signature** - Check webhook secret
4. **Manual sync** - Update database from Stripe
5. **Reprocess event** - If idempotent
6. **Notify user** - If access affected
7. **Fix webhook handler** - Prevent recurrence

### If CSR Calculation Error
1. **Identify affected companies** - Scope the issue
2. **Pause CSR display** - Prevent confusion
3. **Audit component data** - Toolbox, inspections, docs
4. **Recalculate manually** - Verify formula
5. **Fix calculation logic** - Backend correction
6. **Batch recalculate** - All affected companies
7. **Notify property managers** - If scores changed
8. **Document fix** - Update test cases

## 12. Continuous Improvement

### Code Review Checklist
- [ ] System impact scan completed
- [ ] Change manifest filled out
- [ ] Multi-tenant isolation verified
- [ ] Safety invariants maintained
- [ ] Performance requirements met
- [ ] Offline functionality preserved
- [ ] Test coverage adequate
- [ ] Documentation updated
- [ ] Monitoring added
- [ ] Rollback plan defined
- [ ] Subscription logic correct
- [ ] IRATA constraints enforced
- [ ] Document signature flow valid
- [ ] CSR calculation accurate

### Regular Audits
- **Weekly**: Multi-tenant isolation tests
- **Monthly**: Performance benchmarks
- **Quarterly**: Safety compliance review
- **Annually**: Full dependency mapping

### Documentation Maintenance
- Update when dependencies change
- Add new integration points
- Record incident learnings
- Share pattern discoveries
- Maintain troubleshooting guides
- Update for new feature areas

---

## Database Table Reference (40+ Tables)

For quick reference, the system includes these major table groups:

### Core Business Tables
- `users` - All user accounts (companies, employees, residents, property managers, superuser)
- `projects` - Work projects with drop tracking and progress
- `clients` - CRM client records
- `buildings` - Building information for projects
- `workSessions` - Billable time tracking with GPS
- `nonBillableSessions` - Non-billable time (training, travel, admin)
- `dropLogs` - Directional drop tracking (N/E/S/W)

### Safety & Compliance Tables
- `harnessInspections` - Pre-work harness checks
- `flhaForms` - Field Level Hazard Assessments
- `toolboxMeetings` - Safety meeting records with signatures
- `incidentReports` - Incident tracking and investigation
- `methodStatements` - Project-specific safety procedures
- `equipmentDamageReports` - Gear damage documentation

### Gear Management Tables
- `gearItems` - Equipment inventory
- `gearSerialNumbers` - Serial number tracking with manufacture dates
- `gearAssignments` - Employee-to-gear assignments

### Quote & CRM Tables
- `quotes` - Quote headers with totals
- `quoteServices` - Line items for quotes

### Scheduling Tables
- `scheduledJobs` - Calendar job entries
- `jobAssignments` - Employee assignments with date ranges

### Resident & Property Manager Tables
- `complaints` - Resident complaints
- `complaintNotes` - Communication thread
- `propertyManagerCompanyLinks` - PM-to-vendor relationships

### IRATA & Certification Tables
- `irataTaskLogs` - Task logging for certification hours

### Document & Compliance Tables
- `documentReviewSignatures` - Employee document acknowledgments
- `companyBranding` - White label customization

### Subscription & Metrics Tables
- `mrrSnapshots` - Daily revenue snapshots
- `customerHealthScores` - Churn risk scoring
- `churnEvents` - Cancellation tracking

### Communication Tables
- `featureRequests` - Company feature suggestions
- `featureRequestMessages` - Two-way messaging

### User Preferences Tables
- `userPreferences` - Dashboard card ordering

---

## Critical Reminder: Lives and Livelihoods Depend on This System

Every change you make affects:
- **Worker Safety**: Inspections, equipment tracking, emergency contacts
- **Fair Pay**: Accurate time tracking, proper overtime calculation
- **Regulatory Compliance**: Safety documentation, audit trails
- **Business Operations**: Project tracking, client billing
- **Data Security**: Multi-tenant isolation, privacy protection
- **Subscription Revenue**: Billing accuracy, tier enforcement
- **Industry Standards**: IRATA certification tracking, CSR ratings

**Think globally. Test thoroughly. Deploy carefully.**

**Every line of code has system-wide implications.**

This dependency-aware framework ensures the Rope Access Management System maintains its "It Just Works" standard across all features, all companies, and all field operations. No exceptions.
