# Dependency-Aware Development: Overarching Principles & Mandatory Workflow

## 1) Why this exists

Changes in one feature often produce **ripple effects** across tightly coupled systems including taxes, payments, receipts, emails, admin views, storage, and webhooks. The Orange Shirt Society Licensing Portal operates with zero tolerance for errors under the "It Just Works" principle, making system-wide impact awareness critical.

**Local fixes are prohibited** unless a **system-wide impact scan** is performed and verified. Every change must be evaluated for its effects on:
- Fee calculation and display consistency
- Province detection and normalization
- Tax computation with provincial GST/HST rates
- Tax type determination (GST vs HST)
- Payment processing and Stripe integration
- Status transitions and workflow logic
- Receipt generation with correct tax labels
- Email delivery with provincial tax info
- Admin dashboard functionality
- Provincial tax analytics and reporting
- Object storage operations
- Webhook processing and retry logic

## 2) Canonical order of operations

The system follows this mandatory sequence for any licence/checkout flow:

1. **Base fee determined** - Using pricing rules, business size, and product category
2. **Province detection** - Normalize and validate province for Canadian addresses
3. **Apply coupon/discount** - Backend validation and calculation only
4. **Compute tax after discount** - Provincial GST/HST rate on discounted amount, never on original
5. **Determine tax type** - Set tax label as "GST" or "HST" based on province
6. **Decide payment path** - Create Stripe intent OR skip if total is $0
7. **Generate receipt** - Include tax breakdown with correct GST/HST label and GST number
8. **Send emails/notifications** - Approval, denial, or completion emails with provincial tax
9. **Persist artefacts to object storage** - Never local filesystem, always cloud storage
10. **Update status / post-payment webhooks** - Final status transitions and confirmations

## 3) Non-negotiable invariants

The system must always uphold these invariants:

- **Provincial tax accuracy** - Correct GST (5%) or HST (13-15%) rate applied based on province
- **Tax type consistency** - "GST" or "HST" label displayed correctly everywhere based on province
- **Tax is calculated after discounts** - Never tax the original amount; use provincial rate; round to 2 decimals; display consistently across all touchpoints
- **Backend is single source of truth** - Frontend uses backend's calculated `finalAmount` and tax type; never re-computes discounts or tax client-side
- **$0 totals skip Stripe** - Applications with 100% coupons follow non-payment status paths
- **Receipt completeness** - Must include line-item fee, discount (with code), provincial tax (with correct GST/HST label and rate), total, and GST number
- **Admin/manual parity** - Admin entries use identical provincial tax/fee engines as user flows
- **No PST/QST collection** - Only federal GST or harmonized HST collected, never provincial sales tax
- **No tax exemptions** - No Indian Act or other exemptions applied
- **Persistent cloud storage** - Agreements, receipts, and digital assets stored only in object storage
- **Status transition integrity** - All status changes follow validated transition rules
- **Webhook idempotency** - Payment confirmations handle retries without duplication

## 4) System Impact Scan (must run before any change)

Complete this checklist before editing any code or documentation:

**File Impact Analysis:**
- [ ] Identify all files that compute or display fee, discount, tax, totals, status, receipts, emails
- [ ] Verify province detection and normalization logic
- [ ] Check all hardcoded "GST" labels are replaced with dynamic tax type
- [ ] Map integrations across Province ↔ Coupon ↔ Tax ↔ Payment ↔ Receipt ↔ Email ↔ Admin ↔ Analytics ↔ Storage ↔ Webhooks
- [ ] Trace data flow end-to-end (address input → province detection → API → DB → side effects → PDFs/emails)
- [ ] Enumerate affected touchpoints (UI screens showing tax type, agreement/receipt templates, email bodies, admin views, provincial analytics)

**Integration Verification:**
- [ ] Verify status transitions maintain valid state machine
- [ ] Confirm webhook processing remains idempotent
- [ ] Validate object storage operations for all file types
- [ ] Check email template consistency across all pathways

**Testing Requirements:**
- [ ] Update unit tests for all impacted code branches
- [ ] Verify integration tests cover edge cases
- [ ] Test manual admin flows match automated user flows
- [ ] Validate all 8 license pathway interactions

**Documentation Updates:**
- [ ] Update all relevant instruction documents
- [ ] Verify cross-links between dependent modules
- [ ] Update dependency maps and invariant lists

## 5) Change Manifest template (include in every PR)

```markdown
### Scope
- Feature/bug: [Description]
- Entry points touched: [List of modified endpoints/components]

### Contracts
- Inputs/outputs changed? [Y/N + details]
- Downstream consumers updated? [List affected systems]

### Dependency Map
- Upstream deps: [Systems that feed this change]
- Downstream deps: [Systems that consume this change's outputs]

### Invariants Verified
- [ ] Provincial tax rate correctly applied (GST 5% or HST 13-15%)
- [ ] Tax type label correct for province (GST vs HST)
- [ ] Tax calculated after discount using provincial rate
- [ ] $0 totals skip Stripe with correct status
- [ ] Backend total and tax type used by UI (no frontend recalculation)
- [ ] Receipt shows complete tax breakdown with correct GST/HST label + GST number
- [ ] No PST/QST collected (federal/harmonized only)
- [ ] No tax exemptions applied
- [ ] Object storage used for all persistent files
- [ ] Status transitions follow validation rules
- [ ] Webhook processing remains idempotent

### Tests
- Unit: [List of unit tests added/updated, including all 13 provinces]
- Integration/E2E: [End-to-end test coverage for each province]
- Edge cases: [100% coupon, expired coupon, international no-tax, missing province, province variations, admin parity]

### Docs
- Updated instruction files: [List of documentation changes]
- Cross-links verified: [Dependencies updated]
```

## 6) Regression Test Matrix

| Test Case | Fee Calculation | Tax Application | Payment Flow | Receipt Generation | Status Transition |
|-----------|----------------|-----------------|--------------|-------------------|-------------------|
| Ontario (HST 13%) | Base fee applied | HST 13% on full amount | Stripe intent created | Shows "HST (13%)" | draft → pending → approved |
| Alberta (GST 5%) | Base fee applied | GST 5% on full amount | Stripe intent created | Shows "GST (5%)" | draft → pending → approved |
| Nova Scotia (HST 15%) | Base fee applied | HST 15% on full amount | Stripe intent created | Shows "HST (15%)" | draft → pending → approved |
| Quebec (GST only) | Base fee applied | GST 5% on full amount (no QST) | Stripe intent created | Shows "GST (5%)" | draft → pending → approved |
| Percentage coupon + HST | Discount applied first | HST on discounted amount | Stripe intent for final | Shows discount + HST | draft → pending → approved |
| 100% coupon | Full discount | No tax on $0 | Skip Stripe entirely | Shows $0 total | draft → submitted → approved |
| International no-tax | Base fee only | No tax applied | Stripe intent created | No tax breakdown | draft → pending → approved |
| Missing province | Base fee applied | GST 5% (default) | Stripe intent created | Shows "GST (5%)" | draft → pending → approved |
| Manual admin entry | Same fee engine | Provincial tax rules | Manual status update | Correct GST/HST label | direct to approved |
| Webhook retry | No recalculation | Preserved amounts | Idempotent processing | Single receipt sent | No duplicate transitions |

## 7) Observability & rollback

**Required Logging:**
- Original amount, discount percentage/amount, backend final amount
- Province detection and normalization result
- Tax calculation (province, rate, tax type, base amount, computed tax)
- Payment intent decision (create vs skip)
- Receipt ID and generation timestamp with tax type
- Coupon code and validation result
- Status transition with timestamp

**Critical Alerts:**
- Invalid or missing province for Canadian address
- Wrong tax rate for province (e.g., 5% for Ontario)
- Tax type mismatch (GST shown for HST province)
- Stripe intents created for $0 totals
- Missing tax breakdown in receipts
- Webhook retry spike patterns
- Payment status sync failures
- Object storage upload failures

**Rollback Procedures:**
- Restore prior fee/tax calculation libraries atomically
- Re-render receipts from stored data snapshots
- Revert status transitions using audit trail
- Restore email templates and configurations

## 8) Anti-patterns (fail conditions)

**Prohibited Practices:**
- Recomputing totals in the UI instead of using backend values
- Calculating tax before applying discounts
- Creating Stripe payment intents for $0 totals
- Storing files on local filesystem instead of object storage
- Editing webhook logic without comprehensive E2E test coverage
- Making status transitions without validation rules
- Modifying email templates without testing all pathways
- Changing fee calculation without admin parity verification

**Zero Tolerance Violations:**
- Any inconsistency between displayed amounts and charged amounts
- Tax calculations that don't match across all system touchpoints
- Payment flows that bypass standard validation
- Manual admin processes that produce different results than user flows
- File operations that risk data loss through local storage

## 9) Enforcement & Compliance

**Pre-commit Requirements:**
- All instruction documents must contain "Dependency Impact & Invariants" sections
- Cross-links to this document must be maintained
- Test coverage must include edge cases and integration scenarios

**Code Review Gates:**
- System Impact Scan completion verified
- Change Manifest template completed
- Regression test matrix updated
- Documentation cross-references updated

This dependency-aware development framework ensures the Orange Shirt Society Licensing Portal maintains its "It Just Works" standard across all 8 license pathways and supporting systems.